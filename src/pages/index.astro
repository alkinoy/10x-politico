---
import Layout from "../layouts/Layout.astro";
import RecentStatementsFeed from "../components/feed/RecentStatementsFeed";
import type { PaginatedResponse, StatementDTO } from "../types";

// Step 2: Setup API Data Fetching in Astro (SSR)
// ========================================================================

// Extract page number from query params
const pageParam = Astro.url.searchParams.get("page");
const initialPage = pageParam ? parseInt(pageParam, 10) : 1;

// Fetch initial statements data from API
let initialData: PaginatedResponse<StatementDTO> | null = null;
let fetchError: string | null = null;

try {
  // Build API URL for internal fetch
  const apiUrl = new URL("/api/statements", Astro.url.origin);
  apiUrl.searchParams.set("page", initialPage.toString());
  apiUrl.searchParams.set("limit", "50");
  apiUrl.searchParams.set("sort_by", "created_at");
  apiUrl.searchParams.set("order", "desc");

  const response = await fetch(apiUrl.toString());

  if (!response.ok) {
    const errorData = await response.json();
    fetchError = errorData.error?.message || "Failed to load statements";
  } else {
    initialData = await response.json();
  }
} catch (error) {
  console.error("Error fetching statements during SSR:", error);
  fetchError = "Unable to load statements. Please try again later.";
}

// Get current user ID from session (if authenticated)
const session = Astro.locals.session;
const currentUserId = session?.user?.id || null;
---

<Layout title="Recent Statements | SpeechKarma">
  <main class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      {
        initialData ? (
          <RecentStatementsFeed
            client:load
            initialData={initialData}
            initialPage={initialPage}
            currentUserId={currentUserId}
          />
        ) : (
          <div class="text-center py-12">
            <p class="text-red-600 mb-4">{fetchError || "Failed to load statements"}</p>
            <a href="/" class="text-blue-600 hover:underline">
              Retry
            </a>
          </div>
        )
      }
    </div>
  </main>
</Layout>
